<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calendar</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .company-section {
            padding-left: 20px;
        }
        .time-section {
            padding-left: 40px;
        }
    </style>
</head>
<body>
    <h1>Salary Calendar</h1>
    <!-- <form id="hours-form">
        <label for="company">Select Company:</label>
        <select id="company" name="company">
            公司選擇列表將由JavaScript動態填充
        </select>
        <br>
        <label for="start_datetime">Start Time:</label>
        <input type="datetime-local" id="start_datetime" name="start_datetime" required>
        <br>
        <label for="end_datetime">End Time:</label>
        <input type="datetime-local" id="end_datetime" name="end_datetime" required>
        <br>
        <button type="submit">Add</button>
    </form> -->
    <form id="time-form">
        <select id="company" name="company">
            <!-- Company options will be populated by JavaScript -->
        </select>
        <div class="form-group">
            <label for="date">Select Date:</label>
            <input type="date" id="date" name="date" required>
        </div>
        
        <div class="form-group">
            <label for="start_hour">Start Hour:</label>
            <select id="start_hour" name="start_hour">
                <!-- Hour options will be populated by JavaScript -->
            </select>
            <label for="start_minute">Start Minute:</label>
            <select id="start_minute" name="start_minute">
                <!-- Minute options will be populated by JavaScript -->
            </select>
        </div>

        <div class="form-group">
            <label for="end_hour">End Hour:</label>
            <select id="end_hour" name="end_hour">
                <!-- Hour options will be populated by JavaScript -->
            </select>
            <label for="end_minute">End Minute:</label>
            <select id="end_minute" name="end_minute">
                <!-- Minute options will be populated by JavaScript -->
            </select>
        </div>

        <button type="submit">Submit</button>
    </form>

    <br>
    <form id="deleteForm">
        <div class="form-group">
            <label for="deleteId">ID:</label>
            <input type="text" id="deleteId" name="del_id" required>
        </div>
        <button type="submit">Submit</button>
    </form>
    <br>

    <div id="results"></div>
    <div id="calendar"></div>

    <h2>Weekly Totals</h2>
    <table id="weekly_totals">
        <!-- Weekly totals will be loaded here -->
    </table>

    <h2>Monthly Totals</h2>
    <table id="monthly_totals">
        <!-- Monthly totals will be loaded here -->
    </table>
    <button onclick="saveData()">Save Data</button>
    <button onclick="exportData()">Export Data</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hourSelects = document.querySelectorAll('select[name$="_hour"]');
            const minuteSelects = document.querySelectorAll('select[name$="_minute"]');

            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                hourSelects.forEach(select => select.appendChild(option.cloneNode(true)));
            }

            for (let i = 0; i < 60; i += 5) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                minuteSelects.forEach(select => select.appendChild(option.cloneNode(true)));
            }
            
            
            // 從API獲取公司信息並填充公司選擇列表
            fetch('/api/companies')
                .then(response => response.json())
                .then(data => {
                    const companySelect = document.getElementById('company');
                    Object.keys(data).forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companySelect.appendChild(option);
                    });
                });
            fetch('/api/get_res')  // 替换为实际的 API 路径
                .then(response => response.json())
                .then(data => {
                    // console.log('Fetched Data for Calendar:', data);
                    generateCalendar(data); // 重新生成日历
                })
                .catch(error => {
                console.error('Error fetching data for calendar:', error);
            });
            loadWeeklyTotals();
            loadMonthlyTotals();
        });
        document.getElementById('deleteForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('deleteId').value;

            fetch(`/remove/${id}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.message) {
                    alert(data.message);
                } else if (data.error) {
                    alert(data.error);
                }
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while trying to delete the data.');
            });
        });

        document.getElementById('time-form').addEventListener('submit', function(event) {
            event.preventDefault();

            // const formData = new FormData(this);
            const data = {};

            // 从表单数据中提取日期和时间字段
            const company = document.getElementById('company').value;
            const date = document.getElementById('date').value;
            const startHour = document.getElementById('start_hour').value;
            const startMinute = document.getElementById('start_minute').value;
            const endHour = document.getElementById('end_hour').value;
            const endMinute = document.getElementById('end_minute').value;

            // 格式化开始时间和结束时间
            const startTime = `${startHour.padStart(2, '0')}:${startMinute.padStart(2, '0')}`;
            const endTime = `${endHour.padStart(2, '0')}:${endMinute.padStart(2, '0')}`;

            // 组织数据
            data.company = company;
            data.date = date;
            data.start_datetime = startTime;
            data.end_datetime = endTime;

            console.log('Form Data:', data);

            fetch('/calculate_hours', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log(result);
                
                // 清空之前的結果
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';

                // 處理返回的結果並顯示
                if (result.error) {
                    resultsDiv.innerHTML = `<p>Error: ${result.error}</p>`;
                } else {
                    Object.keys(result).forEach(company => {
                        const companyData = result[company];
                        // console.log(companyData);

                        // Object.keys(companyData).forEach(date => {
                        // const entries = companyData[date];
                        
                        // if (entries.length > 0) {
                            // 取最新的一笔数据
                            // const latestEntry = entries;
                            const entryHTML = `
                                <div class="entry">
                                    <p><strong>Company:</strong> ${company}</p>
                                    <p><strong>Date:</strong> ${date}</p>
                                    <p><strong>Morning Hours:</strong> ${companyData.morning_hours}h</p>
                                    <p><strong>Evening Hours:</strong> ${companyData.evening_hours}h</p>
                                    <p><strong>Total Salary:</strong> $${companyData.total_salary}</p>
                                    <p><strong>Lunch Duration:</strong> ${companyData.lunch_duration}h</p>
                                    <p><strong>Dinner Duration:</strong> ${companyData.dinner_duration}h</p>
                                </div>
                                <hr>
                            `;
                            resultsDiv.innerHTML = entryHTML;  // 用新内容更新
                        // }
                    // });
                    });
                    // loadWeeklyTotals();
                    // loadMonthlyTotals();
                    
                }

                fetch('/api/get_res')  // Replace with the actual API path
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched Data for Calendar:', data);
                    generateCalendar(data); // Update the calendar view
                })
                .catch(error => {
                    console.error('Error fetching data for calendar:', error);
                });
            })

            .catch(error => {
                console.error('Error:', error);
            });
        });

        // 生成日曆
        function generateCalendar(data) {
            let calendarHTML = '<table><tr><th>Date</th><th>Details</th></tr>';
            const allDates = new Set();

            // 收集所有日期
            for (let company in data) {
                for (let date in data[company]) {
                    allDates.add(date);
                }
            }

            // 排序日期
            const sortedDates = Array.from(allDates).sort();

            // 為每個日期生成表格行
            sortedDates.forEach(date => {
                // 确保日期格式一致 (YYYY-MM-DD)
                const formattedDate = formatDate(date);

                let dateHTML = `<tr><td>${formattedDate}</td><td>`;

                // 收集該日期的所有公司
                const companies = new Set();
                for (let company in data) {
                    if (data[company][date]) {
                        companies.add(company);
                    }
                }
                let totalDailySalary = 0;
                companies.forEach(company => {
                    
                    dateHTML += `<div class="company-section">
                                    <strong>${company}</strong>
                                    <div>`;
                    
                    data[company][date].forEach(entry => {
                        const totalHours = entry.morning_hours + entry.evening_hours;
                        const entrySalary = entry.total_salary;

                        // console.log(entry);
                        
                        totalDailySalary += entrySalary;
                        dateHTML += `<div class="time-section">
                                        ${entry.morning_hours}h Morning | ${entry.evening_hours}h Evening | ID: ${entry.id}
                                        <br>Total Salary: $${entrySalary}
                                    </div>`;
                    });

                    dateHTML += `</div></div>`;
                });
                dateHTML += `<div class="total-salary-section">
                    <strong>Total Salary for the Day: $${totalDailySalary}</strong>
                </div>`;

                dateHTML += `</td></tr>`;
                calendarHTML += dateHTML;
            });

            calendarHTML += '</table>';
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        function formatDate(date) {
            // 确保日期格式为 YYYY-MM-DD
            const dateObj = new Date(date);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // 月份从0开始
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function loadWeeklyTotals() {
            // Fetch overall weekly totals
            fetch('/api/overall_weekly_totals')
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('weekly_totals');
                    table.innerHTML = '<tr><th>Week</th><th>Total Salary</th><th>Total Hours</th></tr>';

                    // Ensure weeks 1 to 5 are included
                    for (let week = 1; week <= 5; week++) {
                        // Fetch totals for the current week or default to 0 if no data
                        const weekKey = `week_${week}`;
                        const totals = data[weekKey] || { total_salary: 0, total_hours: 0 };

                        const row = `<tr>
                            <td>Week ${week}</td>
                            <td>${totals.total_salary}</td>
                            <td>${totals.total_hours}</td>
                        </tr>`;
                        table.innerHTML += row;
                    }
                })
                .catch(error => {
                    console.error('Error loading weekly totals:', error);
                });
        }

        function loadMonthlyTotals() {
            // Fetch monthly totals
            fetch('/api/monthly_totals')
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('monthly_totals');
                    table.innerHTML = '<tr><th>Total Salary</th><th>Total Hours</th></tr>';
                    const row = `<tr>
                        <td>${data.total_salary}</td>
                        <td>${data.total_hours}</td>
                    </tr>`;
                    table.innerHTML += row;
                    

                })
                .catch(error => {
                    console.error('Error loading monthly totals:', error);
                });
        }
        // 導出數據
        // function exportData() {
        //     window.location.href = '/export';
        //     location.reload();
        // }

        function saveData() {
        // Fetch request to save the data without downloading
            fetch('/save', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);  // Show success message
                    location.reload();
                } else if (data.error) {
                    alert(data.error);  // Show error message
                }
            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert('Failed to save data. Please try again.');
            });
        }

        function exportData() {
            // Fetch the file from the server for download
            fetch('/export')
                .then(response => {
                    if (response.ok) {
                        return response.blob();  // Get the file data as a blob
                    } else {
                        return response.json().then(err => { throw new Error(err.error); });
                    }
                })
            .then(blob => {
                    // Create a link element to download the file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'data.json';  // Set the default file name
                    document.body.appendChild(a);
                    a.click();  // Trigger the download
                    a.remove();  // Remove the link after downloading
                })
            .catch(error => {
                    console.error('Error exporting data:', error);
                    alert('Failed to export data. Please try again.');
            });
        }
    

        // 生成日曆，假設在JS變量'data'中有數據
        // const data = JSON.parse('{{ data|safe }}');
        // generateCalendar(data);
    </script>
</body>
</html>
