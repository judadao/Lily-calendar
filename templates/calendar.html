<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calendar</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <h1>Salary Calendar</h1>

    <div class="container my-4">
        <div class="row">
            <!-- Left Form -->
            <div class="col-md-6">
                <form id="time-form" class="mb-4">
                    <div class="mb-3">
                        <label for="company" class="form-label">Select Company:</label>
                        <select id="company" name="company" class="form-select">
                            <!-- Company options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Select Date:</label>
                        <input type="date" id="date" name="date" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Start Time:</label>
                        <div class="d-flex">
                            <select id="start_hour" name="start_hour" class="form-select me-2">
                                <!-- Hour options will be populated by JavaScript -->
                            </select>
                            <select id="start_minute" name="start_minute" class="form-select">
                                <!-- Minute options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">End Time:</label>
                        <div class="d-flex">
                            <select id="end_hour" name="end_hour" class="form-select me-2">
                                <!-- Hour options will be populated by JavaScript -->
                            </select>
                            <select id="end_minute" name="end_minute" class="form-select">
                                <!-- Minute options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <div class="row">
                    <!-- Delete Form -->
                    <div class="col-md-12 mb-4">
                        <form id="deleteForm">
                            <div class="mb-3">
                                <label for="deleteId" class="form-label">ID:</label>
                                <input type="text" id="deleteId" name="del_id" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>

                    <!-- Results Section -->
                    <div class="col-md-12">
                        <div id="results" class="border p-3">
                            <!-- Results will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="results"></div>
    <div id="calendar"></div>

    <h2 class="my-4">Weekly Totals</h2>
    <table id="weekly_totals" class="table table-bordered table-striped">
        <!-- Weekly totals will be loaded here -->
    </table>

    <h2 class="my-4">Monthly Totals</h2>
    <table id="monthly_totals" class="table table-bordered table-striped">
        <!-- Monthly totals will be loaded here -->
    </table>

    <button onclick="saveData()">Save Data</button>
    <button onclick="exportData()">Export Data</button>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hourSelects = document.querySelectorAll('select[name$="_hour"]');
        const minuteSelects = document.querySelectorAll('select[name$="_minute"]');

        for (let i = 0; i < 24; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i.toString().padStart(2, '0');
            hourSelects.forEach(select => select.appendChild(option.cloneNode(true)));
        }

        for (let i = 0; i < 60; i += 5) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i.toString().padStart(2, '0');
            minuteSelects.forEach(select => select.appendChild(option.cloneNode(true)));
        }


        // 從API獲取公司信息並填充公司選擇列表
        fetch('/api/companies')
            .then(response => response.json())
            .then(data => {
                const companySelect = document.getElementById('company');
                Object.keys(data).forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companySelect.appendChild(option);
                });
            });
        fetch('/api/get_res')  // 替换为实际的 API 路径
            .then(response => response.json())
            .then(data => {
                // console.log('Fetched Data for Calendar:', data);
                generateCalendar(data); // 重新生成日历
            })
            .catch(error => {
                console.error('Error fetching data for calendar:', error);
            });
        loadWeeklyTotals();
        loadMonthlyTotals();
    });
    document.getElementById('deleteForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const id = document.getElementById('deleteId').value;

        fetch(`/remove/${id}`, {
            method: 'DELETE',
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.message) {
                    alert(data.message);
                } else if (data.error) {
                    alert(data.error);
                }
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while trying to delete the data.');
            });
    });

    document.getElementById('time-form').addEventListener('submit', function (event) {
        event.preventDefault();

        // const formData = new FormData(this);
        const data = {};

        // 从表单数据中提取日期和时间字段
        const company = document.getElementById('company').value;
        const date = document.getElementById('date').value;
        const startHour = document.getElementById('start_hour').value;
        const startMinute = document.getElementById('start_minute').value;
        const endHour = document.getElementById('end_hour').value;
        const endMinute = document.getElementById('end_minute').value;

        // 格式化开始时间和结束时间
        const startTime = `${startHour.padStart(2, '0')}:${startMinute.padStart(2, '0')}`;
        const endTime = `${endHour.padStart(2, '0')}:${endMinute.padStart(2, '0')}`;

        // 组织数据
        data.company = company;
        data.date = date;
        data.start_datetime = startTime;
        data.end_datetime = endTime;

        console.log('Form Data:', data);

        fetch('/calculate_hours', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                console.log(result);

                // 清空之前的結果
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';

                // 處理返回的結果並顯示
                if (result.error) {
                    resultsDiv.innerHTML = `<p>Error: ${result.error}</p>`;
                } else {
                    Object.keys(result).forEach(company => {
                        const companyData = result[company];

                        const entryHTML = `
                                <div class="entry">
                                    <p><strong>Company:</strong> ${company}</p>
                                    <p><strong>Date:</strong> ${date}</p>
                                    <p><strong>Morning Hours:</strong> ${companyData.morning_hours}h</p>
                                    <p><strong>Evening Hours:</strong> ${companyData.evening_hours}h</p>
                                    <p><strong>Total Salary:</strong> $${companyData.total_salary}</p>
                                    <p><strong>Lunch Duration:</strong> ${companyData.lunch_duration}h</p>
                                    <p><strong>Dinner Duration:</strong> ${companyData.dinner_duration}h</p>
                                </div>
                                <hr>
                            `;
                        resultsDiv.innerHTML = entryHTML;  // 用新内容更新
                        // }
                        // });
                    });
                    // loadWeeklyTotals();
                    // loadMonthlyTotals();

                }

                fetch('/api/get_res')  // Replace with the actual API path
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched Data for Calendar:', data);
                        generateCalendar(data); // Update the calendar view
                    })
                    .catch(error => {
                        console.error('Error fetching data for calendar:', error);
                    });
            })

            .catch(error => {
                console.error('Error:', error);
            });
    });

    // 生成日曆
    function generateCalendar(data) {
        let calendarHTML = `
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <th>Date</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>`;

        const allDates = new Set();

        // Collect all dates
        for (let company in data) {
            for (let date in data[company]) {
                allDates.add(date);
            }
        }

        // Sort dates
        const sortedDates = Array.from(allDates).sort();

        // Generate table rows for each date
        sortedDates.forEach(date => {
            const formattedDate = formatDate(date);
            const weekday = getWeekday(date);
            const isWeekend = weekday === 'Saturday' || weekday === 'Sunday';
            const rowClass = isWeekend ? 'table-danger' : ''; // Apply a different class for weekends

            let dateHTML = `<tr class="${rowClass}"><td>${formattedDate} (${weekday})</td><td>`;

            // Collect all companies for the date
            const companies = new Set();
            for (let company in data) {
                if (data[company][date]) {
                    companies.add(company);
                }
            }

            let totalDailySalary = 0;
            companies.forEach(company => {
                dateHTML += `
                <div class="accordion my-2" id="accordion-${date}-${company}">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-${date}-${company}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${date}-${company}" aria-expanded="false" aria-controls="collapse-${date}-${company}">
                                <strong>${company}</strong>
                            </button>
                        </h2>
                        <div id="collapse-${date}-${company}" class="accordion-collapse collapse" aria-labelledby="heading-${date}-${company}" data-bs-parent="#accordion-${date}-${company}">
                            <div class="accordion-body">`;

                data[company][date].forEach(entry => {
                    const totalHours = entry.morning_hours + entry.evening_hours;
                    const entrySalary = entry.total_salary;

                    totalDailySalary += entrySalary;

                    // Enhanced formatting for Morning/Evening hours and ID
                    dateHTML += `
                    <div class="d-flex flex-column border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-primary">${entry.morning_hours}h Morning</span>
                                <span class="badge bg-secondary">${entry.evening_hours}h Evening</span>
                            </div>
                            <div class="text-success ms-3">
                                <strong>$${entrySalary}</strong>
                            </div>
                        </div>
                        <div class="mt-2 text-muted">
                            <strong>ID:</strong> <code>${entry.id}</code>
                        </div>
                    </div>`;
                });

                dateHTML += `</div></div></div></div>`;
            });

            dateHTML += `
            <div class="alert alert-warning mt-2">
                <strong>Total Salary for the Day: $${totalDailySalary}</strong>
            </div>`;

            dateHTML += `</td></tr>`;
            calendarHTML += dateHTML;
        });

        calendarHTML += `</tbody></table>`;
        document.getElementById('calendar').innerHTML = calendarHTML;
    }

    // Function to format the date as YYYY-MM-DD
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Function to get the weekday name
    function getWeekday(dateString) {
        const date = new Date(dateString);
        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return weekdays[date.getDay()];
    }


    function formatDate(date) {
        // 确保日期格式为 YYYY-MM-DD
        const dateObj = new Date(date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // 月份从0开始
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function loadWeeklyTotals() {
        // Fetch overall weekly totals
        fetch('/api/overall_weekly_totals')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('weekly_totals');
                table.innerHTML = '<thead><tr><th>Week</th><th>Total Salary</th><th>Total Hours</th></tr></thead><tbody>';

                // Ensure weeks 1 to 5 are included
                for (let week = 1; week <= 5; week++) {
                    // Fetch totals for the current week or default to 0 if no data
                    const weekKey = `week_${week}`;
                    const totals = data[weekKey] || { total_salary: 0, total_hours: 0 };

                    const row = `<tr>
                    <td>Week ${week}</td>
                    <td>${totals.total_salary.toFixed(2)}</td>
                    <td>${totals.total_hours.toFixed(2)}</td>
                </tr>`;
                    table.innerHTML += row;
                }

                table.innerHTML += '</tbody>';
            })
            .catch(error => {
                console.error('Error loading weekly totals:', error);
            });
    }

    function loadMonthlyTotals() {
        // Fetch monthly totals
        fetch('/api/monthly_totals')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('monthly_totals');
                table.innerHTML = '<thead><tr><th>Total Salary</th><th>Total Hours</th></tr></thead><tbody>';
                const row = `<tr>
                <td>${data.total_salary.toFixed(2)}</td>
                <td>${data.total_hours.toFixed(2)}</td>
            </tr>`;
                table.innerHTML += row;
                table.innerHTML += '</tbody>';
            })
            .catch(error => {
                console.error('Error loading monthly totals:', error);
            });
    }
    // 導出數據
    // function exportData() {
    //     window.location.href = '/export';
    //     location.reload();
    // }

    function saveData() {
        // Fetch request to save the data without downloading
        fetch('/save', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);  // Show success message
                    location.reload();
                } else if (data.error) {
                    alert(data.error);  // Show error message
                }
            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert('Failed to save data. Please try again.');
            });
    }

    function exportData() {
        // Fetch the file from the server for download
        fetch('/export')
            .then(response => {
                if (response.ok) {
                    return response.blob();  // Get the file data as a blob
                } else {
                    return response.json().then(err => { throw new Error(err.error); });
                }
            })
            .then(blob => {
                // Create a link element to download the file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';  // Set the default file name
                document.body.appendChild(a);
                a.click();  // Trigger the download
                a.remove();  // Remove the link after downloading
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                alert('Failed to export data. Please try again.');
            });
    }


        // 生成日曆，假設在JS變量'data'中有數據
        // const data = JSON.parse('{{ data|safe }}');
        // generateCalendar(data);
</script>
</body>

</html>